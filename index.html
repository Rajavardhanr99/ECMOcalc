<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced ECMO Calculator Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://css.gg/css?=&name=info|droplet" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f8f8fA;
            --text-color: #1d1d1f;
            --subtle-text-color: #6e6e73;
            --accent-color: #0071e3;
            --border-color: #d2d2d7;
            --card-bg: #ffffff;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .main-container {
            transition: opacity 0.5s ease-in-out;
        }

        .tab-button {
            position: relative;
            transition: color 0.3s ease;
            color: var(--subtle-text-color);
            padding: 1rem 0;
            margin: 0 1rem;
            cursor: pointer;
        }

        .tab-button::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: var(--accent-color);
            transform: scaleX(0);
            transform-origin: center;
            transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        }

        .tab-button.active {
            color: var(--text-color);
            font-weight: 600;
        }

        .tab-button.active::after {
            transform: scaleX(1);
        }
        
        .tab-content {
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        .tab-content.hidden {
            opacity: 0;
            position: absolute;
            pointer-events: none;
            transform: translateY(10px);
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 1.25rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .input-field {
            background-color: #f5f5f7;
            border: 1px solid #e5e5e7;
            border-radius: 0.75rem;
            transition: border-color 0.3s, box-shadow 0.3s;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .input-field:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.2);
            outline: none;
        }
        select.input-field {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        
        select option.recommended-cannula {
            background-color: #22c55e; /* green-500 */
            color: white;
            font-weight: 600;
        }
        
        .mode-button {
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }
        .mode-button.active {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        
        .result-display {
            background: linear-gradient(135deg, #f5f5f7, #e8e8ed);
            border-radius: 1rem;
        }
        
        .cannula-graph { position: relative; }
        .cannula-graph svg { width: 100%; height: auto; }
        .cannula-graph .axis-line { stroke: #c0c0c5; stroke-width: 1.5; }
        .cannula-graph .grid-line { stroke: #e5e5e7; stroke-dasharray: 4 4; stroke-width: 1; }
        .cannula-graph .axis-label { font-size: 10px; fill: var(--subtle-text-color); }
        .cannula-graph .curve { fill: none; stroke-width: 2.5; transition: stroke 0.4s ease, stroke-width 0.4s ease; }
        .cannula-graph .curve-active { stroke-width: 4; stroke: var(--accent-color); }
        .cannula-graph .curve-inactive { stroke: var(--border-color); opacity: 0.7; }
        .cannula-graph .op-point { fill: var(--accent-color); stroke: white; stroke-width: 2; transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1); r: 0; }
        .cannula-graph .op-point.visible { r: 6; }
        .cannula-graph .safe-zone { fill: #22c55e; opacity: 0.1; }
        .cannula-graph .limit-line { stroke: #ef4444; stroke-width: 2; stroke-dasharray: 5 5; }
        .cannula-graph .target-flow-line { stroke: #1d4ed8; stroke-width: 1.5; stroke-dasharray: 6 6;}
        .cannula-graph .target-flow-range { fill: #1d4ed8; opacity: 0.08; }

        
        .slider-container { display: flex; align-items: center; gap: 1rem; }
        .slider-value { font-weight: 600; color: var(--accent-color); min-width: 50px; text-align: center; }

    </style>
</head>
<body class="p-4 md:p-8">

    <div class="main-container mx-auto max-w-7xl opacity-0">
        
        <header class="text-center mb-10 md:mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900 tracking-tight">ECMO Suite</h1>
            <p class="text-gray-600 mt-3 text-lg">Precision Calculators for Critical Care.</p>
        </header>

        <!-- Tabs Navigation -->
        <div class="mb-8 border-b border-gray-200 flex justify-center flex-wrap">
            <nav class="flex" aria-label="Tabs">
                <button class="tab-button active" data-tab="flow">ECMO Flow</button>
                <button class="tab-button" data-tab="cannula">Cannula Sizing</button>
                <button class="tab-button" data-tab="heparin">Heparin Protocol</button>
                <button class="tab-button" data-tab="oxygen">Oxygen Delivery</button>
            </nav>
        </div>

        <!-- Tab Content Wrapper -->
        <div class="relative">
            <!-- Flow Calculator -->
            <div id="flow-content" class="tab-content">
                <div class="card p-6 md:p-8 max-w-3xl mx-auto">
                     <h2 class="text-2xl font-semibold mb-6 text-gray-800">Calculate Required Blood Flow</h2>
                     <div class="grid grid-cols-1 gap-y-6">
                        <div>
                           <label class="block text-sm font-medium text-gray-600 mb-2">ECMO Mode</label>
                           <div class="flex rounded-lg border border-gray-200 p-1">
                                <button id="flow-vv-mode-btn" class="mode-button active flex-1 py-2 px-4 rounded-md">VV ECMO</button>
                                <button id="flow-va-mode-btn" class="mode-button flex-1 py-2 px-4 rounded-md">VA ECMO</button>
                           </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 items-end">
                             <div class="space-y-2">
                                <label for="flow-weight-slider" class="block text-sm font-medium text-gray-600">Patient Weight</label>
                                <div class="slider-container">
                                    <input type="range" id="flow-weight-slider" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" min="1" max="150" value="70">
                                    <span id="flow-weight-value" class="slider-value">70 kg</span>
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label for="flow-height-slider" class="block text-sm font-medium text-gray-600">Patient Height</label>
                                <div class="slider-container">
                                    <input type="range" id="flow-height-slider" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" min="50" max="220" value="175">
                                    <span id="flow-height-value" class="slider-value">175 cm</span>
                                </div>
                            </div>
                        </div>
                        <div id="flow-vv-inputs">
                            <div class="space-y-2">
                                <label for="flow-rate" class="block text-sm font-medium text-gray-600">Target Flow Rate</label>
                                 <div class="slider-container">
                                     <input type="range" id="flow-rate" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" min="50" max="70" value="60">
                                     <span id="flow-rate-value" class="slider-value">60 ml/kg/min</span>
                                 </div>
                            </div>
                        </div>
                        <div id="flow-va-inputs" class="hidden">
                            <div class="space-y-2">
                                <label for="flow-current-slider" class="block text-sm font-medium text-gray-600">Current ECMO Flow</label>
                                <div class="slider-container">
                                    <input type="range" id="flow-current-slider" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" min="1" max="8" value="4" step="0.1">
                                    <span id="flow-current-value" class="slider-value">4.0 L/min</span>
                                </div>
                            </div>
                        </div>
                     </div>
                     <div id="flow-result-container" class="mt-8">
                          <div class="result-display p-6 text-center space-y-2">
                             <h3 class="font-semibold text-lg text-gray-800 mb-1">Calculated ECMO Target Flow</h3>
                             <p id="flow-result" class="text-4xl font-bold text-accent-color"></p>
                             <div id="va-result-details" class="text-sm text-gray-600"></div>
                             <div id="va-support-percent" class="text-lg font-semibold text-gray-800 mt-2"></div>
                         </div>
                     </div>
                </div>
            </div>

            <!-- Cannula Sizing Calculator -->
            <div id="cannula-content" class="tab-content hidden">
                 <!-- Content will be populated by JS -->
            </div>
            
            <!-- Heparin Protocol Calculator -->
            <div id="heparin-content" class="tab-content hidden">
                 <!-- Content will be populated by JS -->
            </div>

            <!-- Oxygen Delivery Calculator -->
            <div id="oxygen-content" class="tab-content hidden">
                 <!-- Content will be populated by JS -->
            </div>
        </div>
        
        <footer class="text-center mt-12 text-sm text-gray-500">
            <p>Developed by Dr. Rajavardhan Rangappa</p>
            <p class="text-xs text-gray-400 mt-2 max-w-2xl mx-auto"><strong>Disclaimer:</strong> This tool is for educational purposes only and should not be used for clinical decision-making without verification by qualified healthcare professionals.</p>
        </footer>
    </div>

<script>
// This script will populate the content of the tabs dynamically
// to avoid duplicating large HTML blocks and to make maintenance easier.

function getCannulaSizingHTML() {
    return `
    <div class="card p-6 md:p-8">
        <h2 class="text-2xl font-semibold mb-6 text-gray-800">Cannula Sizing & Performance</h2>
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8 items-start">
            <div class="lg:col-span-1 space-y-4">
                <div>
                   <label class="block text-sm font-medium text-gray-600 mb-2">ECMO Mode</label>
                   <div class="flex rounded-lg border border-gray-200 p-1">
                        <button id="cannula-vv-mode-btn" class="mode-button active flex-1 py-2 px-4 rounded-md text-xs">VV</button>
                        <button id="cannula-va-mode-btn" class="mode-button flex-1 py-2 px-4 rounded-md text-xs">VA</button>
                   </div>
                </div>
                <div>
                    <label for="cannula-weight-slider" class="block text-sm font-medium text-gray-600">Weight</label>
                    <div class="slider-container"><input type="range" id="cannula-weight-slider" class="w-full" min="1" max="150" value="70"><span id="cannula-weight-value" class="slider-value">70 kg</span></div>
                </div>
                <div>
                    <label for="cannula-height-slider" class="block text-sm font-medium text-gray-600">Height</label>
                    <div class="slider-container"><input type="range" id="cannula-height-slider" class="w-full" min="50" max="220" value="175"><span id="cannula-height-value" class="slider-value">175 cm</span></div>
                </div>
                <div>
                    <label for="cannula-flow" class="block text-sm font-medium text-gray-600">Target Flow (L/min)</label>
                    <input type="number" id="cannula-flow" class="w-full p-3 input-field" placeholder="Auto-calculated">
                </div>
                
                <div class="space-y-2 pt-2">
                   <h4 class="font-semibold text-gray-800">Cannula Selection</h4>
                   <label for="drainage-cannula-select" class="block text-xs font-medium text-gray-500">Drainage</label>
                   <select id="drainage-cannula-select" class="w-full p-3 input-field"></select>
                   <label for="return-cannula-select" class="block text-xs font-medium text-gray-500 mt-2">Return</label>
                   <select id="return-cannula-select" class="w-full p-3 input-field"></select>
                </div>
            </div>
            <div class="lg:col-span-3 grid grid-cols-1 gap-8">
               <div class="cannula-graph" id="drainage-graph-container"><h3 class="text-lg font-semibold text-center mb-2">Drainage Cannula Pressure-Flow</h3></div>
               <div class="cannula-graph" id="return-graph-container"><h3 class="text-lg font-semibold text-center mb-2">Return Cannula Pressure-Flow</h3></div>
            </div>
        </div>
    </div>`;
}

function getHeparinProtocolHTML() {
    return `
    <div class="card p-6 md:p-8 max-w-4xl mx-auto">
        <h2 class="text-2xl font-semibold mb-6 text-gray-800">Heparin Infusion Protocol</h2>
         <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
            <div class="space-y-4">
                 <div>
                   <label class="block text-sm font-medium text-gray-600 mb-2">Monitoring Protocol</label>
                   <div class="flex rounded-lg border border-gray-200 p-1">
                        <button id="heparin-aptt-btn" class="mode-button active flex-1 py-2 px-4 rounded-md">aPTT</button>
                        <button id="heparin-act-btn" class="mode-button flex-1 py-2 px-4 rounded-md">ACT</button>
                   </div>
               </div>
                <div>
                    <label for="heparin-weight-slider" class="block text-sm font-medium text-gray-600">Patient Weight</label>
                    <div class="slider-container"><input type="range" id="heparin-weight-slider" class="w-full" min="1" max="150" value="70"><span id="heparin-weight-value" class="slider-value">70 kg</span></div>
                </div>
                <div>
                    <label for="heparin-lab-value-slider" class="block text-sm font-medium text-gray-600">Current Lab Value (<span id="lab-type-label">aPTT</span>)</label>
                    <div class="slider-container"><input type="range" id="heparin-lab-value-slider" class="w-full" min="30" max="150" value="65"><span id="heparin-lab-value" class="slider-value">65</span></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600">Current Infusion Rate</label>
                    <div class="flex rounded-lg border border-gray-200 p-1 mb-2">
                        <button id="rate-unit-kg-btn" class="mode-button active flex-1 py-1 px-3 rounded-md text-xs">units/kg/hr</button>
                        <button id="rate-ml-hr-btn" class="mode-button flex-1 py-1 px-3 rounded-md text-xs">mL/hr</button>
                    </div>
                    <div id="heparin-rate-input-container">
                        <div class="slider-container"><input type="range" id="heparin-current-rate-slider" class="w-full" min="0" max="50" value="15" step="1"><span id="heparin-current-rate-value" class="slider-value">15 u/kg/hr</span></div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="heparin-units" class="block text-sm font-medium text-gray-600">Heparin Units</label>
                        <input type="number" id="heparin-units" class="w-full p-3 input-field" value="25000">
                    </div>
                    <div>
                        <label for="heparin-volume" class="block text-sm font-medium text-gray-600">in Volume (mL)</label>
                        <input type="number" id="heparin-volume" class="w-full p-3 input-field" value="50">
                    </div>
                </div>
            </div>
            <div class="space-y-4">
                <div id="heparin-result-container" class="hidden space-y-4">
                    <div class="result-display p-4"><h4 class="font-semibold text-gray-800">Recommended Action</h4><p id="heparin-action" class="text-xl font-bold text-accent-color"></p></div>
                    <div class="result-display p-4"><h4 class="font-semibold text-gray-800">New Infusion Rate</h4><p id="heparin-new-rate" class="text-xl font-bold text-accent-color"></p></div>
                     <div class="result-display p-4"><h4 class="font-semibold text-gray-800">Rate in mL/hr</h4><p id="heparin-ml-hr" class="text-xl font-bold text-accent-color"></p></div>
                </div>
            </div>
         </div>
     </div>`;
}

function getOxygenDeliveryHTML() {
    return `
    <div class="card p-6 md:p-8 max-w-4xl mx-auto">
        <h2 class="text-2xl font-semibold mb-6 text-gray-800">Oxygen Delivery (DO₂)</h2>
        <div class="grid grid-cols-1 gap-y-6">
            <div class="space-y-2">
                <label for="do2-flow-slider" class="block text-sm font-medium text-gray-600">Total Blood Flow</label>
                <div class="slider-container"><input type="range" id="do2-flow-slider" class="w-full" min="1" max="8" value="5" step="0.1"><span id="do2-flow-value" class="slider-value">5.0 L/min</span></div>
            </div>
            <div class="space-y-2">
                <label for="do2-hb-slider" class="block text-sm font-medium text-gray-600">Hemoglobin</label>
                <div class="slider-container"><input type="range" id="do2-hb-slider" class="w-full" min="5" max="20" value="12" step="0.1"><span id="do2-hb-value" class="slider-value">12.0 g/dL</span></div>
            </div>
            <div class="space-y-2">
                <label for="do2-sao2-slider" class="block text-sm font-medium text-gray-600">Arterial O₂ Saturation</label>
                <div class="slider-container"><input type="range" id="do2-sao2-slider" class="w-full" min="70" max="100" value="99"><span id="do2-sao2-value" class="slider-value">99 %</span></div>
            </div>
        </div>
         <div id="do2-result-container" class="mt-8">
            <div class="result-display p-6 text-center"><h3 class="font-semibold text-lg text-gray-800 mb-1">Calculated Oxygen Delivery (DO₂)</h3><p id="do2-result" class="text-4xl font-bold text-accent-color"></p></div>
        </div>
    </div>`;
}


// Main Application Logic
document.addEventListener('DOMContentLoaded', () => {
    // Initial HTML Population
    document.getElementById('cannula-content').innerHTML = getCannulaSizingHTML();
    document.getElementById('heparin-content').innerHTML = getHeparinProtocolHTML();
    document.getElementById('oxygen-content').innerHTML = getOxygenDeliveryHTML();
    
    // --- Global State ---
    let calculatedFlowL = null;
    let ecmoMode = 'VV';
    let heparinProtocol = 'aPTT';
    let heparinRateMode = 'units'; // 'units' or 'ml'

    // --- DOM Elements ---
    const mainContainer = document.querySelector('.main-container');
    const tabs = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    
    // --- Flow Calc Elements ---
    const flowVVModeBtn = document.getElementById('flow-vv-mode-btn');
    const flowVAModeBtn = document.getElementById('flow-va-mode-btn');
    const flowVVInputs = document.getElementById('flow-vv-inputs');
    const flowVAInputs = document.getElementById('flow-va-inputs');
    const flowWeightSlider = document.getElementById('flow-weight-slider');
    const flowWeightValue = document.getElementById('flow-weight-value');
    const flowHeightSlider = document.getElementById('flow-height-slider');
    const flowHeightValue = document.getElementById('flow-height-value');
    const flowRateSlider = document.getElementById('flow-rate');
    const flowRateValue = document.getElementById('flow-rate-value');
    const flowCurrentSlider = document.getElementById('flow-current-slider');
    const flowCurrentValue = document.getElementById('flow-current-value');
    const flowResultContainer = document.getElementById('flow-result-container');
    const flowResultEl = document.getElementById('flow-result');
    const vaResultDetails = document.getElementById('va-result-details');
    const vaSupportPercentEl = document.getElementById('va-support-percent');
    
    // --- Cannula Calc Elements ---
    const cannulaVVModeBtn = document.getElementById('cannula-vv-mode-btn');
    const cannulaVAModeBtn = document.getElementById('cannula-va-mode-btn');
    const cannulaWeightSlider = document.getElementById('cannula-weight-slider');
    const cannulaWeightValue = document.getElementById('cannula-weight-value');
    const cannulaHeightSlider = document.getElementById('cannula-height-slider');
    const cannulaHeightValue = document.getElementById('cannula-height-value');
    const cannulaFlowInput = document.getElementById('cannula-flow');
    const drainageSelect = document.getElementById('drainage-cannula-select');
    const returnSelect = document.getElementById('return-cannula-select');
    const drainageGraphContainer = document.getElementById('drainage-graph-container');
    const returnGraphContainer = document.getElementById('return-graph-container');

    // --- Heparin Calc Elements ---
    const heparinAPTTBtn = document.getElementById('heparin-aptt-btn');
    const heparinACTBtn = document.getElementById('heparin-act-btn');
    const heparinWeightSlider = document.getElementById('heparin-weight-slider');
    const heparinWeightValue = document.getElementById('heparin-weight-value');
    const heparinLabValueSlider = document.getElementById('heparin-lab-value-slider');
    const heparinLabValue = document.getElementById('heparin-lab-value');
    const labTypeLabel = document.getElementById('lab-type-label');
    const heparinCurrentRateContainer = document.getElementById('heparin-rate-input-container');
    const rateUnitKgBtn = document.getElementById('rate-unit-kg-btn');
    const rateMlHrBtn = document.getElementById('rate-ml-hr-btn');
    const heparinUnitsInput = document.getElementById('heparin-units');
    const heparinVolumeInput = document.getElementById('heparin-volume');
    const heparinResultContainer = document.getElementById('heparin-result-container');
    const heparinActionEl = document.getElementById('heparin-action');
    const heparinNewRateEl = document.getElementById('heparin-new-rate');
    const heparinMlHrEl = document.getElementById('heparin-ml-hr');
    
    // --- DO2 Calc Elements ---
    const do2FlowSlider = document.getElementById('do2-flow-slider');
    const do2FlowValue = document.getElementById('do2-flow-value');
    const do2HbSlider = document.getElementById('do2-hb-slider');
    const do2HbValue = document.getElementById('do2-hb-value');
    const do2Sao2Slider = document.getElementById('do2-sao2-slider');
    const do2Sao2Value = document.getElementById('do2-sao2-value');
    const do2ResultContainer = document.getElementById('do2-result-container');
    const do2ResultEl = document.getElementById('do2-result');

    // --- Data and Constants ---
    const cannulaDatabase = [
        // Maquet HLS Venous (Drainage)
        { key: 'M-19V', brand: 'Maquet', type: 'Venous', size: '19 Fr', pressureFunc: flow => 1.9 * Math.pow(flow, 2) + 5 * flow },
        { key: 'M-21V', brand: 'Maquet', type: 'Venous', size: '21 Fr', pressureFunc: flow => 1.5 * Math.pow(flow, 2) + 4.5 * flow },
        { key: 'M-23V', brand: 'Maquet', type: 'Venous', size: '23 Fr', pressureFunc: flow => 1.1 * Math.pow(flow, 2) + 4 * flow },
        { key: 'M-25V', brand: 'Maquet', type: 'Venous', size: '25 Fr', pressureFunc: flow => 0.8 * Math.pow(flow, 2) + 3.5 * flow },
        // Bio-Medicus NextGen Venous (Drainage)
        { key: 'B-19V', brand: 'Bio-Medicus', type: 'Venous', size: '19 Fr', pressureFunc: flow => 2.2 * Math.pow(flow, 2) + 5.5 * flow },
        { key: 'B-21V', brand: 'Bio-Medicus', type: 'Venous', size: '21 Fr', pressureFunc: flow => 1.7 * Math.pow(flow, 2) + 5 * flow },
        { key: 'B-23V', brand: 'Bio-Medicus', type: 'Venous', size: '23 Fr', pressureFunc: flow => 1.3 * Math.pow(flow, 2) + 4.5 * flow },
        { key: 'B-25V', brand: 'Bio-Medicus', type: 'Venous', size: '25 Fr', pressureFunc: flow => 1.0 * Math.pow(flow, 2) + 4 * flow },
        // Maquet HLS Arterial (Return)
        { key: 'M-15A', brand: 'Maquet', type: 'Arterial', size: '15 Fr', pressureFunc: flow => 6.0 * Math.pow(flow, 2) + 15 * flow },
        { key: 'M-17A', brand: 'Maquet', type: 'Arterial', size: '17 Fr', pressureFunc: flow => 4.5 * Math.pow(flow, 2) + 12 * flow },
        { key: 'M-19A', brand: 'Maquet', type: 'Arterial', size: '19 Fr', pressureFunc: flow => 3.0 * Math.pow(flow, 2) + 10 * flow },
        { key: 'M-21A', brand: 'Maquet', type: 'Arterial', size: '21 Fr', pressureFunc: flow => 2.0 * Math.pow(flow, 2) + 8 * flow },
        // Bio-Medicus NextGen Arterial (Return)
        { key: 'B-15A', brand: 'Bio-Medicus', type: 'Arterial', size: '15 Fr', pressureFunc: flow => 6.5 * Math.pow(flow, 2) + 16 * flow },
        { key: 'B-17A', brand: 'Bio-Medicus', type: 'Arterial', size: '17 Fr', pressureFunc: flow => 5.0 * Math.pow(flow, 2) + 13 * flow },
        { key: 'B-19A', brand: 'Bio-Medicus', type: 'Arterial', size: '19 Fr', pressureFunc: flow => 3.5 * Math.pow(flow, 2) + 11 * flow },
        { key: 'B-21A', brand: 'Bio-Medicus', type: 'Arterial', size: '21 Fr', pressureFunc: flow => 2.5 * Math.pow(flow, 2) + 9 * flow },
    ];
    const drainageCannulas = cannulaDatabase.filter(c => c.type === 'Venous');
    const returnCannulas = cannulaDatabase.filter(c => c.type === 'Arterial');

    const apttProtocol = [
        { range: [0, 45], bolus: 80, change: 4 },
        { range: [46, 54], bolus: 40, change: 2 },
        { range: [55, 75], bolus: 0, change: 0 },
        { range: [76, 90], bolus: 0, change: -2, hold: 0 },
        { range: [91, 100], bolus: 0, change: -2, hold: 30 },
        { range: [101, Infinity], bolus: 0, change: -3, hold: 60 }
    ];
    const actProtocol = [
        { range: [0, 159], bolus: 80, change: 4 },
        { range: [160, 179], bolus: 40, change: 2 },
        { range: [180, 220], bolus: 0, change: 0 },
        { range: [221, 240], bolus: 0, change: -2, hold: 0 },
        { range: [241, 260], bolus: 0, change: -2, hold: 30 },
        { range: [261, Infinity], bolus: 0, change: -3, hold: 60 }
    ];

    // --- Initial Animation ---
    setTimeout(() => mainContainer.style.opacity = '1', 100);

    // --- Tab Logic ---
    tabs.forEach(tab => {
        if (tab) {
             tab.addEventListener('click', () => {
                const targetId = tab.dataset.tab + '-content';
                tabs.forEach(t => { if(t) t.classList.remove('active')});
                tab.classList.add('active');
                tabContents.forEach(content => {
                    if (content) content.classList.toggle('hidden', content.id !== targetId);
                });
                if (tab.dataset.tab === 'cannula') syncToCannulaTab();
                if (tab.dataset.tab === 'oxygen' && calculatedFlowL) do2FlowSlider.value = calculatedFlowL;
            });
        }
    });

    // --- Flow Calculation Logic ---
    function calculateTargetFlow(mode, weight, height, rate) {
        if (!weight || weight <= 0) return null;
        if (mode === 'VV') {
            return (weight * rate) / 1000;
        } else { // VA Mode
            if (!height || height <= 0) return null;
            const bsa = 0.007184 * Math.pow(height, 0.725) * Math.pow(weight, 0.425);
            const cardiacOutput = bsa * 3.0;
            return cardiacOutput * 0.80;
        }
    }
    
    function updateFlowCalculation() {
        vaResultDetails.innerHTML = '';
        vaSupportPercentEl.innerHTML = '';
        const weight = parseFloat(flowWeightSlider.value);
        const height = parseFloat(flowHeightSlider.value);
        const rate = parseInt(flowRateSlider.value);
        
        calculatedFlowL = calculateTargetFlow(ecmoMode, weight, height, rate);

        if (calculatedFlowL === null) {
            flowResultEl.textContent = '-';
            return;
        }

        if (ecmoMode === 'VA') {
            const bsa = 0.007184 * Math.pow(height, 0.725) * Math.pow(weight, 0.425);
            const cardiacOutput = bsa * 3.0;
            vaResultDetails.innerHTML = `<span>Est. BSA: ${bsa.toFixed(2)} m²</span> &bull; <span>Est. Cardiac Output: ${cardiacOutput.toFixed(2)} L/min</span>`;
            
            const currentFlow = parseFloat(flowCurrentSlider.value);
            const supportPercent = (currentFlow / cardiacOutput) * 100;
            vaSupportPercentEl.innerHTML = `Providing <strong>${supportPercent.toFixed(0)}%</strong> of cardiac support.`;
        }
        
        flowResultEl.textContent = `${calculatedFlowL.toFixed(2)} L/min`;
        flowResultContainer.classList.remove('hidden');
    }

    [flowWeightSlider, flowHeightSlider, flowRateSlider, flowCurrentSlider].forEach(el => {
       if(el) el.addEventListener('input', updateFlowCalculation);
    });

    flowRateSlider.addEventListener('input', (e) => flowRateValue.textContent = `${e.target.value} ml/kg/min`);
    flowWeightSlider.addEventListener('input', (e) => flowWeightValue.textContent = `${e.target.value} kg`);
    flowHeightSlider.addEventListener('input', (e) => flowHeightValue.textContent = `${e.target.value} cm`);
    if(flowCurrentSlider) flowCurrentSlider.addEventListener('input', (e) => flowCurrentValue.textContent = `${parseFloat(e.target.value).toFixed(1)} L/min`);


    function setFlowMode(mode) {
        ecmoMode = mode;
        flowVVModeBtn.classList.toggle('active', mode === 'VV');
        flowVAModeBtn.classList.toggle('active', mode === 'VA');
        flowVVInputs.classList.toggle('hidden', mode === 'VA');
        flowVAInputs.classList.toggle('hidden', mode === 'VV');
        updateFlowCalculation();
    }
    
    flowVVModeBtn.addEventListener('click', () => setFlowMode('VV'));
    flowVAModeBtn.addEventListener('click', () => setFlowMode('VA'));

    // --- Cannula Sizing Logic ---
    let cannulaEcmoMode = 'VV';

    function setCannulaMode(mode) {
        cannulaEcmoMode = mode;
        cannulaVVModeBtn.classList.toggle('active', mode === 'VV');
        cannulaVAModeBtn.classList.toggle('active', mode === 'VA');
        updateCannulaSizing();
    }

    cannulaVVModeBtn.addEventListener('click', () => setCannulaMode('VV'));
    cannulaVAModeBtn.addEventListener('click', () => setCannulaMode('VA'));
    
    const populateCannulaSelects = () => {
        const brands = [...new Set(cannulaDatabase.map(c => c.brand))];
        
        // Populate Drainage
        drainageSelect.innerHTML = '';
        brands.forEach(brand => {
            const optgroup = document.createElement('optgroup');
            optgroup.label = brand;
            drainageCannulas.filter(c => c.brand === brand).forEach(cannula => {
                const option = new Option(`${brand} ${cannula.size}`, cannula.key);
                optgroup.appendChild(option);
            });
            drainageSelect.appendChild(optgroup);
        });

        // Populate Return
        returnSelect.innerHTML = '';
        brands.forEach(brand => {
            const optgroup = document.createElement('optgroup');
            optgroup.label = brand;
            returnCannulas.filter(c => c.brand === brand).forEach(cannula => {
                const option = new Option(`${brand} ${cannula.size}`, cannula.key);
                optgroup.appendChild(option);
            });
            returnSelect.appendChild(optgroup);
        });
    };

    const generateSVGGraph = (container, data, activeKey, flow, options) => {
        const { xMax, yMax, limit, yAxisLabel } = options;
        const width = 500, height = 300, margin = { top: 20, right: 20, bottom: 30, left: 40 };
        const xScale = val => margin.left + (val / xMax * (width - margin.left - margin.right));
        const yScale = val => (height - margin.bottom) - (val / yMax * (height - margin.top - margin.bottom));
        
        let targetFlowLines = '';
        if (flow > 0) {
            const flowX = xScale(flow);
            const rangeWidth = xScale(0.5) - xScale(0);
            targetFlowLines = `
                <rect x="${flowX - rangeWidth}" y="${margin.top}" width="${2 * rangeWidth}" height="${height - margin.top - margin.bottom}" class="target-flow-range" />
                <line x1="${flowX}" y1="${margin.top}" x2="${flowX}" y2="${height-margin.bottom}" class="target-flow-line" />
            `;
        }

        const limitY = yScale(limit);
        let curves = '';
        data.forEach(cannula => {
            let pathData = "M";
            for (let i = 0; i <= xMax; i += 0.25) {
                let pressure = cannula.pressureFunc(i);
                if (pressure > yMax) pressure = yMax;
                pathData += `${xScale(i)},${yScale(pressure)} L`;
            }
            curves += `<path d="${pathData.slice(0, -2)}" class="curve ${cannula.key === activeKey ? 'curve-active' : 'curve-inactive'}" />`;
        });
        
        let opPointCircle = '';
        const selectedCannula = data.find(c => c.key === activeKey);
        if (flow && selectedCannula) {
            const pressure = selectedCannula.pressureFunc(flow);
            if (pressure <= yMax) opPointCircle = `<circle cx="${xScale(flow)}" cy="${yScale(pressure)}" class="op-point visible" />`;
        }
        const gridLines = [...Array(5)].map((_, i) => `<line x1="${xScale(i*(xMax/5))}" y1="${margin.top}" x2="${xScale(i*(xMax/5))}" y2="${height-margin.bottom}" class="grid-line" />`).join('') +
                          [...Array(4)].map((_, i) => `<line x1="${margin.left}" y1="${yScale((i+1)*(yMax/5))}" x2="${width-margin.right}" y2="${yScale((i+1)*(yMax/5))}" class="grid-line" />`).join('');
        const labels = `<text x="${width/2}" y="${height-5}" text-anchor="middle" class="axis-label">Flow (L/min)</text>` +
                       `<text x="${-height/2}" y="10" transform="rotate(-90)" text-anchor="middle" class="axis-label">${yAxisLabel}</text>` +
                       [...Array(6)].map((_, i) => `<text x="${xScale(i*(xMax/5))}" y="${height-margin.bottom+15}" text-anchor="middle" class="axis-label">${(i*(xMax/5)).toFixed(0)}</text>`).join('') +
                       [...Array(6)].map((_, i) => `<text x="${margin.left-5}" y="${yScale(i*(yMax/5))+3}" text-anchor="end" class="axis-label">${(i*(yMax/5)).toFixed(0)}</text>`).join('');
        const svg = `
            <svg viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg">
                ${gridLines}
                ${targetFlowLines}
                <rect x="${margin.left}" y="${yAxisLabel.includes('-') ? limitY : margin.top}" width="${width-margin.left-margin.right}" height="${yAxisLabel.includes('-') ? (height-margin.bottom-limitY) : (limitY-margin.top)}" class="safe-zone" />
                <line x1="${margin.left}" y1="${limitY}" x2="${width - margin.right}" y2="${limitY}" class="limit-line" />
                <text x="${width - margin.right + 5}" y="${limitY+3}" font-size="10" fill="#ef4444">${limit} mmHg</text>
                <line x1="${margin.left}" y1="${margin.top}" x2="${margin.left}" y2="${height-margin.bottom}" class="axis-line" />
                <line x1="${margin.left}" y1="${height-margin.bottom}" x2="${width-margin.right}" y2="${height-margin.bottom}" class="axis-line" />
                ${curves} ${opPointCircle} ${labels}
            </svg>`;
        container.innerHTML = container.querySelector('h3').outerHTML + svg;
    };
    
    function updateCannulaSizing() {
        const weight = parseFloat(cannulaWeightSlider.value);
        const height = parseFloat(cannulaHeightSlider.value);
        let targetFlow;

        if (cannulaEcmoMode === 'VV') {
            targetFlow = (weight * 60) / 1000;
        } else {
             targetFlow = calculateTargetFlow('VA', weight, height, 0);
        }
       
        if (targetFlow && targetFlow > 0) {
            cannulaFlowInput.value = targetFlow.toFixed(2);
        } else {
            cannulaFlowInput.value = '';
        }

        let recDrainageKey, recReturnKey;
        if (weight < 40) { recDrainageKey = 'B-19V'; recReturnKey = 'M-15A'; }
        else if (weight < 70) { recDrainageKey = 'M-23V'; recReturnKey = 'B-19A'; }
        else { recDrainageKey = 'B-25V'; recReturnKey = 'M-21A'; }

        // Set the recommended value
        if(!drainageSelect.value) drainageSelect.value = recDrainageKey;
        if(!returnSelect.value) returnSelect.value = recReturnKey;
        
        // Highlight the recommended value
        drainageSelect.querySelectorAll('option').forEach(opt => opt.classList.toggle('recommended-cannula', opt.value === recDrainageKey));
        returnSelect.querySelectorAll('option').forEach(opt => opt.classList.toggle('recommended-cannula', opt.value === recReturnKey));

        const flow = parseFloat(cannulaFlowInput.value) || 0;
        const activeDrainageKey = drainageSelect.value;
        const activeReturnKey = returnSelect.value;
        
        generateSVGGraph(drainageGraphContainer, drainageCannulas, activeDrainageKey, flow, { xMax: 8, yMax: 100, limit: 60, yAxisLabel: 'Pressure Drop (-mmHg)' });
        generateSVGGraph(returnGraphContainer, returnCannulas, activeReturnKey, flow, { xMax: 8, yMax: 250, limit: 150, yAxisLabel: 'Pressure Rise (+mmHg)' });
    }
    
    cannulaWeightSlider.addEventListener('input', (e) => {
        cannulaWeightValue.textContent = `${e.target.value} kg`;
        updateCannulaSizing();
    });
    cannulaHeightSlider.addEventListener('input', (e) => {
        cannulaHeightValue.textContent = `${e.target.value} cm`;
        updateCannulaSizing();
    });
    [cannulaFlowInput, drainageSelect, returnSelect].forEach(el => {
        el.addEventListener('input', updateCannulaSizing);
    });

    // --- Heparin Protocol Logic ---
    function setHeparinProtocol(protocol) {
        heparinProtocol = protocol;
        heparinAPTTBtn.classList.toggle('active', protocol === 'aPTT');
        heparinACTBtn.classList.toggle('active', protocol === 'ACT');
        labTypeLabel.textContent = protocol;
        if(protocol === 'aPTT'){
            heparinLabValueSlider.min = 30;
            heparinLabValueSlider.max = 150;
            heparinLabValueSlider.value = 65;
        } else {
            heparinLabValueSlider.min = 100;
            heparinLabValueSlider.max = 300;
            heparinLabValueSlider.value = 180;
        }
        heparinLabValue.textContent = heparinLabValueSlider.value;
        updateHeparinCalculation();
    }

    function setHeparinRateInputMode(mode) {
        heparinRateMode = mode;
        rateUnitKgBtn.classList.toggle('active', mode === 'units');
        rateMlHrBtn.classList.toggle('active', mode === 'ml');
        const isUnits = mode === 'units';
        heparinCurrentRateContainer.innerHTML = isUnits
            ? `<div class="slider-container"><input type="range" id="heparin-current-rate-slider" class="w-full" min="0" max="50" value="15" step="1"><span id="heparin-current-rate-value" class="slider-value">15 u/kg/hr</span></div>`
            : `<input type="number" id="heparin-current-rate-ml" class="w-full p-3 input-field" placeholder="e.g., 10.4">`;

        const rateSlider = document.getElementById('heparin-current-rate-slider');
        const rateMlInput = document.getElementById('heparin-current-rate-ml');

        if (isUnits && rateSlider) {
            rateSlider.addEventListener('input', e => {
                document.getElementById('heparin-current-rate-value').textContent = `${e.target.value} u/kg/hr`;
                updateHeparinCalculation();
            });
        } else if (rateMlInput) {
            rateMlInput.addEventListener('input', updateHeparinCalculation);
        }
    }
    
    function updateHeparinCalculation() {
        const weight = parseFloat(heparinWeightSlider.value);
        const labValue = parseFloat(heparinLabValueSlider.value);
        const units = parseFloat(heparinUnitsInput.value);
        const volume = parseFloat(heparinVolumeInput.value);
        
        if (!weight || isNaN(labValue) || !units || !volume || volume === 0) {
            heparinResultContainer.classList.add('hidden');
            return;
        }

        let currentRate;
        const concentration = units / volume;
        if (heparinRateMode === 'units') {
            const rateSlider = document.getElementById('heparin-current-rate-slider');
            if (rateSlider) currentRate = parseFloat(rateSlider.value);
        } else {
            const mlRateInput = document.getElementById('heparin-current-rate-ml');
            if (mlRateInput) {
                const mlRate = parseFloat(mlRateInput.value);
                if (isNaN(mlRate)) {
                    heparinResultContainer.classList.add('hidden');
                    return;
                }
                currentRate = (mlRate * concentration) / weight;
            }
        }
        
        if(typeof currentRate === 'undefined') {
            heparinResultContainer.classList.add('hidden');
            return;
        }

        const protocol = heparinProtocol === 'aPTT' ? apttProtocol : actProtocol;
        const action = protocol.find(p => labValue >= p.range[0] && labValue <= p.range[1]);

        if (!action) {
            heparinResultContainer.classList.add('hidden');
            return;
        }

        let actionText = [];
        if (action.bolus > 0) {
            const bolusUnits = action.bolus * weight;
            const bolusMl = bolusUnits / concentration;
            actionText.push(`Bolus ${bolusUnits.toFixed(0)} units (${bolusMl.toFixed(1)} mL)`);
        }
        if (action.hold > 0) {
            actionText.push(`Hold infusion for ${action.hold} min`);
        }
        if (action.change !== 0) {
            actionText.push(`${action.change > 0 ? 'Increase' : 'Decrease'} rate by ${Math.abs(action.change)} units/kg/hr`);
        }
        if (action.change === 0 && action.bolus === 0) {
            actionText.push("No change to infusion rate.");
        }

        heparinActionEl.textContent = actionText.join(', then ');
        const newRate = currentRate + action.change;
        heparinNewRateEl.textContent = `${newRate.toFixed(1)} units/kg/hr`;
        const totalUnitsPerHour = newRate * weight;
        const mlPerHour = totalUnitsPerHour / concentration;
        heparinMlHrEl.textContent = `${mlPerHour.toFixed(1)} mL/hr`;

        heparinResultContainer.classList.remove('hidden');
    }

    heparinAPTTBtn.addEventListener('click', () => setHeparinProtocol('aPTT'));
    heparinACTBtn.addEventListener('click', () => setHeparinProtocol('ACT'));
    rateUnitKgBtn.addEventListener('click', () => setHeparinRateInputMode('units'));
    rateMlHrBtn.addEventListener('click', () => setHeparinRateInputMode('ml'));
    heparinWeightSlider.addEventListener('input', e => {
        heparinWeightValue.textContent = `${e.target.value} kg`;
        updateHeparinCalculation();
    });
     heparinLabValueSlider.addEventListener('input', e => {
        heparinLabValue.textContent = e.target.value;
        updateHeparinCalculation();
    });
    [heparinUnitsInput, heparinVolumeInput].forEach(el => {
        el.addEventListener('input', updateHeparinCalculation);
    });

    // --- Syncing and Initial Setup ---
    function syncToCannulaTab() {
        cannulaWeightSlider.value = flowWeightSlider.value;
        cannulaHeightSlider.value = flowHeightSlider.value;
        cannulaWeightValue.textContent = `${flowWeightSlider.value} kg`;
        cannulaHeightValue.textContent = `${flowHeightSlider.value} cm`;
        updateCannulaSizing();
    }
    
    // --- Oxygen Delivery Calculator ---
    function updateDO2Calculation() {
        const flow = parseFloat(do2FlowSlider.value), hb = parseFloat(do2HbSlider.value), sao2 = parseFloat(do2Sao2Slider.value);
        if (!flow || !hb || !sao2) return;
        const do2 = flow * hb * 1.34 * (sao2 / 100) * 10;
        do2ResultEl.textContent = `${do2.toFixed(0)} ml O₂/min`;
        do2ResultContainer.classList.remove('hidden');
    }

    [do2FlowSlider, do2HbSlider, do2Sao2Slider].forEach(el => {
        el.addEventListener('input', updateDO2Calculation);
    });
    do2FlowSlider.addEventListener('input', e => do2FlowValue.textContent = `${parseFloat(e.target.value).toFixed(1)} L/min`);
    do2HbSlider.addEventListener('input', e => do2HbValue.textContent = `${parseFloat(e.target.value).toFixed(1)} g/dL`);
    do2Sao2Slider.addEventListener('input', e => do2Sao2Value.textContent = `${e.target.value} %`);

    // --- Initial Setup Calls ---
    populateCannulaSelects();
    setHeparinProtocol('aPTT');
    setHeparinRateInputMode('units');
    updateFlowCalculation();
    updateCannulaSizing();
    updateHeparinCalculation();
    updateDO2Calculation();
});
</script>

</body>
</html>

