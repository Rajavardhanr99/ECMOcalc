<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced ECMO Calculator Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'accent': '#0071e3',
                        'success': '#10b981', // Emerald 500
                        'light-blue': '#f0f9ff', // Sky 50
                    },
                }
            }
        }
    </script>
    <style>
        :root {
            --bg-color: #f8f8fA;
            --text-color: #1d1d1f;
            --subtle-text-color: #6e6e73;
            --accent-color: #0071e3;
            --success-color: #10b981;
            --border-color: #d2d2d7;
            --card-bg: #ffffff;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .main-container {
            transition: opacity 0.5s ease-in-out;
        }

        .tab-button {
            position: relative;
            transition: all 0.3s ease;
            color: var(--subtle-text-color);
            padding: 0.5rem 1rem;
            margin: 0 0.25rem;
            cursor: pointer;
            white-space: nowrap;
            border-radius: 9999px;
            border: 1px solid transparent;
        }
        @media (min-width: 640px) {
            .tab-button { margin: 0 0.5rem; padding: 0.5rem 1.25rem; }
        }

        .tab-button.active {
            color: var(--accent-color);
            font-weight: 600;
            background-color: #eaf5ff;
            border-color: #aed8f6;
        }
        
        .tab-content {
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        .tab-content.hidden {
            display: none;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 1.25rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        
        .formula-card {
            background-color: #f9fafb; /* gray-50 */
            border: 1px solid #e5e7eb; /* gray-200 */
        }
        .formula {
            background-color: #eef2ff; /* indigo-50 */
            color: #312e81; /* indigo-900 */
            padding: 0.25rem 0.6rem;
            border-radius: 0.375rem;
            font-family: 'Georgia', 'Times New Roman', Times, serif;
            font-size: 1.05em;
            display: inline-block;
            border: 1px solid #e0e7ff; /* indigo-100 */
        }

        .input-field {
            background-color: #f5f5f7;
            border: 1px solid #e5e5e7;
            border-radius: 0.75rem;
            transition: border-color 0.3s, box-shadow 0.3s;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .input-field:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.2);
            outline: none;
        }
        select.input-field {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        
        select option.recommended-cannula {
            background-color: var(--success-color);
            color: white;
            font-weight: 600;
        }
        
        .mode-button {
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }
        .mode-button.active {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        
        .result-display {
            background: linear-gradient(135deg, #f5f5f7, #e8e8ed);
            border-radius: 1rem;
        }
        
        /* Custom Slider Styles */
        input[type="range"] {
            -webkit-appearance: none; appearance: none;
            width: 100%; height: 8px;
            background: #e0f2fe; border-radius: 5px;
            outline: none; opacity: 0.9;
            transition: opacity .2s;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 20px; height: 20px;
            background: var(--accent-color); cursor: pointer;
            border-radius: 50%; border: 2px solid white;
            box-shadow: 0 0 2px rgba(0,0,0,0.2);
        }
        input[type="range"]::-moz-range-thumb {
            width: 18px; height: 18px;
            background: var(--accent-color); cursor: pointer;
            border-radius: 50%; border: 2px solid white;
            box-shadow: 0 0 2px rgba(0,0,0,0.2);
        }

        .slider-container { display: flex; align-items: center; gap: 1rem; }
        .slider-value { font-weight: 600; color: var(--accent-color); min-width: 70px; text-align: center; }

        /* Cannula Graph Styles */
        .cannula-graph svg { width: 100%; height: auto; }
        .cannula-graph .axis-label { font-size: 10px; fill: var(--subtle-text-color); }
        .cannula-graph .curve { fill: none; stroke-width: 2.5; transition: stroke 0.4s ease, stroke-width 0.4s ease; }
        .cannula-graph .curve-active { stroke-width: 4; stroke: var(--accent-color); }
        .cannula-graph .curve-inactive { stroke: #d1d5db; opacity: 0.6; } /* gray-300 */
        .cannula-graph .axis-line { stroke: #9ca3af; stroke-width: 1.5; } /* gray-400 */
        .cannula-graph .grid-line { stroke: #e5e7eb; stroke-dasharray: 2 4; stroke-width: 1; } /* gray-200 */
        .cannula-graph .limit-line { stroke: #ef4444; stroke-width: 1.5; stroke-dasharray: 4 4; } /* red-500 */
        .cannula-graph .target-flow-range { fill: #3b82f6; opacity: 0.1; } /* blue-500 */
        .cannula-graph .target-flow-line { stroke: #1e40af; stroke-width: 2; } /* dark blue */
        .cannula-graph .op-point { r: 0; transition: r 0.3s ease; }
        .cannula-graph .op-point.visible { fill: var(--accent-color); stroke: white; stroke-width: 2; r: 5; }

    </style>
</head>
<body class="p-4 md:p-8">

    <div class="main-container mx-auto max-w-7xl opacity-0">
        
        <header class="text-center mb-10 md:mb-12">
            <h1 class="text-3xl md:text-5xl font-bold tracking-tight bg-gradient-to-r from-blue-600 to-green-500 text-transparent bg-clip-text">ECMO Suite</h1>
            <p class="text-gray-600 mt-3 text-base md:text-lg">Precision Calculators for Critical Care.</p>
        </header>

        <!-- Tabs Navigation -->
        <div class="mb-8 border-b border-gray-200 flex justify-center flex-wrap">
            <nav class="flex items-center p-1" aria-label="Tabs">
                <button class="tab-button active" data-tab="flow">ECMO Flow</button>
                <button class="tab-button" data-tab="cannula">Cannula Sizing</button>
                <button class="tab-button" data-tab="heparin">Heparin Protocol</button>
                <button class="tab-button" data-tab="oxygenation">Oxygenation</button>
            </nav>
        </div>

        <!-- Tab Content Wrapper -->
        <div class="relative">
            <!-- Flow Calculator -->
            <div id="flow-content" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                    <div class="lg:col-span-3">
                         <div class="card p-6 md:p-8 h-full">
                             <h2 class="text-2xl font-semibold mb-6 text-gray-800">Calculate Required Blood Flow</h2>
                             <div class="grid grid-cols-1 gap-y-6">
                                <div>
                                   <label class="block text-sm font-medium text-gray-600 mb-2">ECMO Mode</label>
                                   <div class="flex rounded-lg border border-gray-200 p-1">
                                        <button id="flow-vv-mode-btn" class="mode-button active flex-1 py-2 px-4 rounded-md">VV ECMO</button>
                                        <button id="flow-va-mode-btn" class="mode-button flex-1 py-2 px-4 rounded-md">VA ECMO</button>
                                   </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 items-end">
                                     <div class="space-y-2">
                                        <label for="flow-weight-slider" class="block text-sm font-medium text-gray-600">Patient Weight</label>
                                        <div class="slider-container">
                                            <input type="range" id="flow-weight-slider" min="1" max="150" value="70">
                                            <span id="flow-weight-value" class="slider-value">70 kg</span>
                                        </div>
                                    </div>
                                    <div class="space-y-2">
                                        <label for="flow-height-slider" class="block text-sm font-medium text-gray-600">Patient Height</label>
                                        <div class="slider-container">
                                            <input type="range" id="flow-height-slider" min="50" max="220" value="175">
                                            <span id="flow-height-value" class="slider-value">175 cm</span>
                                        </div>
                                    </div>
                                </div>
                                <div id="flow-vv-inputs">
                                    <div class="space-y-2">
                                        <label for="flow-rate" class="block text-sm font-medium text-gray-600">Target Flow Rate</label>
                                         <div class="slider-container">
                                             <input type="range" id="flow-rate" min="50" max="100" value="60">
                                             <span id="flow-rate-value" class="slider-value">60 ml/kg/min</span>
                                         </div>
                                    </div>
                                </div>
                                <div id="flow-va-inputs" class="hidden">
                                    <div class="space-y-2">
                                        <label for="flow-current-slider" class="block text-sm font-medium text-gray-600">Current ECMO Flow</label>
                                        <div class="slider-container">
                                            <input type="range" id="flow-current-slider" min="1" max="8" value="4" step="0.1">
                                            <span id="flow-current-value" class="slider-value">4.0 L/min</span>
                                        </div>
                                    </div>
                                </div>
                             </div>
                             <div id="flow-result-container" class="mt-8">
                                  <div class="result-display p-6 text-center space-y-2">
                                     <h3 class="font-semibold text-lg text-gray-800 mb-1">Calculated ECMO Target Flow</h3>
                                     <p id="flow-result" class="text-4xl font-bold text-accent"></p>
                                     <div id="va-result-details" class="text-sm text-gray-600"></div>
                                     <div id="va-support-percent" class="text-lg font-semibold text-gray-800 mt-2"></div>
                                 </div>
                             </div>
                        </div>
                    </div>
                    <div class="lg:col-span-2">
                         <div class="card formula-card p-6 h-full">
                            <h3 class="text-xl font-semibold mb-4 text-gray-800">Formulas Used</h3>
                            <div class="space-y-6 text-sm text-gray-700">
                                <div id="flow-vv-formulas">
                                    <h4 class="font-semibold text-base text-gray-800 mb-2">VV ECMO Flow</h4>
                                    <p><span class="formula">Flow = (Weight &times; Rate) / 1000</span></p>
                                    <ul class="list-disc list-inside mt-2 space-y-1">
                                        <li><code>Weight</code> in kg</li>
                                        <li><code>Rate</code> in ml/kg/min</li>
                                        <li>Result is in <strong>L/min</strong></li>
                                    </ul>
                                </div>
                                <div id="flow-va-formulas" class="hidden">
                                     <h4 class="font-semibold text-base text-gray-800 mb-2">VA ECMO Flow (Du Bois)</h4>
                                     <p><span class="formula">BSA = 0.007184 &times; H^0.725 &times; W^0.425</span></p>
                                     <p class="mt-2"><span class="formula">Est. CO = BSA &times; CI</span></p>
                                     <p class="mt-2"><span class="formula">Target Flow = Est. CO &times; 80%</span></p>
                                     <ul class="list-disc list-inside mt-2 space-y-1">
                                         <li><code>BSA</code>: Body Surface Area (m²)</li>
                                         <li><code>H</code>: Height (cm), <code>W</code>: Weight (kg)</li>
                                         <li><code>CI</code>: Cardiac Index (assumed 3.0 L/min/m²)</li>
                                     </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cannula Sizing Calculator -->
            <div id="cannula-content" class="tab-content hidden"></div>
            <!-- Heparin Protocol Calculator -->
            <div id="heparin-content" class="tab-content hidden"></div>
            <!-- Oxygenation & Health Calculator -->
            <div id="oxygenation-content" class="tab-content hidden"></div>
        </div>
        
        <footer class="text-center mt-12 text-sm text-gray-500">
            <p>Developed by Dr. Rajavardhan Rangappa</p>
            <p class="text-xs text-gray-400 mt-2 max-w-2xl mx-auto"><strong>Disclaimer:</strong> This tool is for educational purposes only and should not be used for clinical decision-making without verification by qualified healthcare professionals.</p>
        </footer>
    </div>

<script>
// --- TEMPLATE FUNCTIONS --- //
function getCannulaSizingHTML() {
    return `
    <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
        <div class="lg:col-span-2">
            <div class="card p-6 md:p-8 h-full">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">Cannula Sizing</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600">Weight</label>
                        <div class="slider-container"><input type="range" id="cannula-weight-slider" min="1" max="150" value="70"><span id="cannula-weight-value" class="slider-value">70 kg</span></div>
                    </div>
                    <div>
                        <label for="cannula-flow" class="block text-sm font-medium text-gray-600">Operating Flow (L/min)</label>
                        <input type="number" id="cannula-flow" class="w-full p-3 input-field" placeholder="Auto-calculated" step="0.1">
                        <p class="text-xs text-gray-500 mt-1">Adjust to see operating point on graph. Recommended range shown in blue.</p>
                    </div>
                    <div class="space-y-2 pt-2">
                       <h4 class="font-semibold text-gray-800">Cannula Selection</h4>
                       <label for="drainage-cannula-select" class="block text-xs font-medium text-gray-500">Drainage</label>
                       <select id="drainage-cannula-select" class="w-full p-3 input-field"></select>
                       <label for="return-cannula-select" class="block text-xs font-medium text-gray-500 mt-2">Return</label>
                       <select id="return-cannula-select" class="w-full p-3 input-field"></select>
                    </div>
                </div>
            </div>
        </div>
        <div class="lg:col-span-3">
             <div class="card p-6 h-full">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Pressure-Flow Performance</h3>
                <div class="grid grid-cols-1 gap-4">
                   <div class="cannula-graph" id="drainage-graph-container"></div>
                   <div class="cannula-graph" id="return-graph-container"></div>
                </div>
             </div>
        </div>
    </div>`;
}

function getHeparinProtocolHTML() {
    return `
    <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
        <div class="lg:col-span-3">
            <div class="card p-6 md:p-8 h-full">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">Heparin Infusion Protocol</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-8">
                    <!-- Left Column: Inputs and Results -->
                    <div class="space-y-6">
                         <div>
                           <label class="block text-sm font-medium text-gray-600 mb-2">Patient & Lab Data</label>
                           <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 space-y-4">
                               <div>
                                    <label for="heparin-weight-slider" class="block text-xs font-medium text-gray-600">Patient Weight</label>
                                    <div class="slider-container"><input type="range" id="heparin-weight-slider" min="1" max="150" value="70"><span id="heparin-weight-value" class="slider-value">70 kg</span></div>
                                </div>
                               <div>
                                    <label for="heparin-lab-value-slider" class="block text-xs font-medium text-gray-600">Current Lab Value (<span id="lab-type-label">aPTT</span>)</label>
                                    <div class="slider-container"><input type="range" id="heparin-lab-value-slider" min="30" max="150" value="65" step="0.1"><span id="heparin-lab-value" class="slider-value">65</span></div>
                                </div>
                           </div>
                       </div>
                       <div id="heparin-result-container" class="hidden space-y-4">
                            <div class="result-display p-4"><h4 class="font-semibold text-gray-800">Recommended Action</h4><p id="heparin-action" class="text-lg font-bold text-accent"></p></div>
                            <div class="result-display p-4"><h4 class="font-semibold text-gray-800">New Infusion Rate</h4><p id="heparin-new-rate" class="text-lg font-bold text-accent"></p></div>
                       </div>
                    </div>
                    <!-- Right Column: Protocol Selection -->
                    <div class="space-y-6">
                        <div>
                           <label class="block text-sm font-medium text-gray-600 mb-2">Protocol & Infusion Setup</label>
                           <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 space-y-4">
                                <div class="flex rounded-lg border border-gray-200 p-1">
                                    <button id="heparin-aptt-btn" class="mode-button active flex-1 py-2 px-4 rounded-md text-xs">aPTT</button>
                                    <button id="heparin-act-btn" class="mode-button flex-1 py-2 px-4 rounded-md text-xs">ACT</button>
                                    <button id="heparin-xa-btn" class="mode-button flex-1 py-2 px-4 rounded-md text-xs">Anti-Xa</button>
                               </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="heparin-units" class="block text-xs font-medium text-gray-600">Units</label>
                                        <input type="number" id="heparin-units" class="w-full p-2 input-field" value="25000">
                                    </div>
                                    <div>
                                        <label for="heparin-volume" class="block text-xs font-medium text-gray-600">Volume (mL)</label>
                                        <input type="number" id="heparin-volume" class="w-full p-2 input-field" value="50">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600">Current Rate</label>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="heparin-current-rate-input" class="w-full p-2 input-field" value="15">
                                        <select id="heparin-rate-unit-select" class="input-field p-2 text-xs">
                                            <option value="units">u/kg/hr</option>
                                            <option value="ml">mL/hr</option>
                                        </select>
                                    </div>
                                </div>
                           </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="lg:col-span-2">
            <div class="card formula-card p-6 h-full">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Protocol Logic</h3>
                <div class="space-y-6 text-sm text-gray-700">
                    <div>
                        <h4 class="font-semibold text-base text-gray-800 mb-2">Rate Conversion</h4>
                        <p>Calculations use <code>units/kg/hr</code>. If you input <code>mL/hr</code>, it's converted using:</p>
                        <p class="mt-2"><span class="formula">Concentration = Total Units / Total Volume</span></p>
                        <p class="mt-2"><span class="formula">Rate (u/kg/hr) = (Rate (mL/hr) &times; C) / W</span></p>
                    </div>
                    <div class="mt-4">
                        <h4 class="font-semibold text-base text-gray-800 mb-2">Adjustable Target Range</h4>
                        <div class="flex items-center gap-2 p-2 bg-white border border-gray-300 rounded-lg">
                            <input type="number" id="heparin-target-min" class="w-full p-2 input-field text-center">
                            <span class="text-gray-500">-</span>
                            <input type="number" id="heparin-target-max" class="w-full p-2 input-field text-center">
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Adjust the therapeutic target range for the selected protocol.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>`;
}

function getOxygenationHealthHTML() {
    return `
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column: Patient & Circuit Inputs -->
        <div class="lg:col-span-1 space-y-6">
            <div class="card p-6">
                <h3 class="font-semibold text-lg mb-4">Patient & Circuit Inputs</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-600">ECMO Blood Flow</label>
                        <div class="slider-container"><input type="range" id="oxy-flow-slider" min="1" max="8" value="4" step="0.1"><span id="oxy-flow-value" class="slider-value">4.0 L/min</span></div>
                    </div>
                     <div>
                        <label class="block text-xs font-medium text-gray-600">Hemoglobin</label>
                        <div class="slider-container"><input type="range" id="oxy-hb-slider" min="5" max="20" value="10" step="0.1"><span id="oxy-hb-value" class="slider-value">10.0 g/dL</span></div>
                    </div>
                </div>
            </div>
             <div class="card p-6">
                <h3 class="font-semibold text-lg mb-4">Recirculation (VV ECMO)</h3>
                 <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-600">Pre-Membrane Saturation (SpreO₂)</label>
                        <div class="slider-container"><input type="range" id="oxy-pre-sat-slider" min="50" max="100" value="75"><span id="oxy-pre-sat-value" class="slider-value">75 %</span></div>
                    </div>
                     <div>
                        <label class="block text-xs font-medium text-gray-600">Post-Membrane Saturation (Spo₂)</label>
                        <div class="slider-container"><input type="range" id="oxy-post-sat-slider" min="95" max="100" value="100" step="0.1"><span id="oxy-post-sat-value" class="slider-value">100.0 %</span></div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600">Venous Saturation (SvO₂)</label>
                        <div class="slider-container"><input type="range" id="oxy-recirc-svo2-slider" min="30" max="95" value="70"><span id="oxy-recirc-svo2-value" class="slider-value">70 %</span></div>
                    </div>
                    <div class="result-display p-3 text-center">
                        <h4 class="font-semibold text-gray-800 text-sm">Recirculation %</h4>
                        <p id="oxy-recirculation-result" class="text-2xl font-bold text-accent"></p>
                    </div>
                    <div class="formula-card p-3 rounded-lg text-xs mt-2">
                        <span class="formula">((SpreO₂ - SvO₂) / (SpoO₂ - SvO₂)) &times; 100</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Middle Column: Oxygenator Performance -->
        <div class="lg:col-span-1 space-y-6">
             <div class="card p-6">
                <h3 class="font-semibold text-lg mb-4">Oxygenator Health</h3>
                <div class="space-y-4">
                    <div>
                         <label class="block text-xs font-medium text-gray-600">Oxygenator Model</label>
                         <select id="oxy-model-select" class="w-full p-2 input-field"></select>
                    </div>
                    <div>
                         <label class="block text-xs font-medium text-gray-600">Current TMP</label>
                         <input type="number" id="oxy-tmp-input" class="w-full p-2 input-field" placeholder="e.g., 45 mmHg">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600">Membrane PaO₂ (Optional)</label>
                        <div class="grid grid-cols-2 gap-2">
                             <input type="number" id="oxy-pre-pao2-input" class="w-full p-2 input-field" placeholder="Pre">
                             <input type="number" id="oxy-post-pao2-input" class="w-full p-2 input-field" placeholder="Post">
                        </div>
                    </div>
                    <div id="oxy-health-result" class="result-display p-3 text-center"></div>
                     <div class="result-display p-3 text-center mt-4">
                         <h4 class="font-semibold text-gray-800 text-sm">O₂ Transfer Rate (mL/min)</h4>
                         <p id="oxy-transfer-result" class="text-2xl font-bold text-accent"></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Column: Systemic Calculations -->
        <div class="lg:col-span-1 space-y-6">
             <div class="card p-6">
                <h3 class="font-semibold text-lg mb-4">Systemic Oxygenation</h3>
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Arterial (SaO₂)</label>
                        <div class="slider-container"><input type="range" id="oxy-sao2-slider" min="70" max="100" value="99"><span id="oxy-sao2-value" class="slider-value">99 %</span></div>
                        <input type="number" id="oxy-pao2-input" value="100" class="w-full p-2 mt-2 input-field" placeholder="PaO₂ (mmHg)">
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Venous (SvO₂)</label>
                        <div class="slider-container"><input type="range" id="oxy-svo2-slider" min="30" max="95" value="70"><span id="oxy-svo2-value" class="slider-value">70 %</span></div>
                        <input type="number" id="oxy-pvo2-input" value="40" class="w-full p-2 mt-2 input-field" placeholder="PvO₂ (mmHg)">
                    </div>
                </div>
             </div>
             <div class="card p-6">
                 <h3 class="font-semibold text-lg mb-4">Calculated Results</h3>
                 <div class="space-y-4">
                    <div class="result-display p-3"><h4 class="font-semibold text-gray-800 text-sm">Delivery (DO₂)</h4><p id="oxy-do2-result" class="text-2xl font-bold text-accent"></p></div>
                    <div class="result-display p-3"><h4 class="font-semibold text-gray-800 text-sm">Consumption (VO₂)</h4><p id="oxy-vo2-result" class="text-2xl font-bold text-accent"></p></div>
                    <div class="result-display p-3"><h4 class="font-semibold text-gray-800 text-sm">Extraction (OER)</h4><p id="oxy-oer-result" class="text-2xl font-bold text-success"></p></div>
                 </div>
                 <div class="formula-card p-3 mt-4 rounded-lg text-xs space-y-2">
                    <p><span class="formula">DO₂ = CaO₂ &times; Flow &times; 10</span></p>
                    <p><span class="formula">VO₂ = (CaO₂ - CvO₂) &times; Flow &times; 10</span></p>
                    <p><span class="formula">OER = ((CaO₂ - CvO₂) / CaO₂) &times; 100</span></p>
                 </div>
             </div>
        </div>
    </div>
    `;
}


// --- MAIN SCRIPT --- //
document.addEventListener('DOMContentLoaded', () => {
    // --- Initial HTML Population ---
    document.getElementById('cannula-content').innerHTML = getCannulaSizingHTML();
    document.getElementById('heparin-content').innerHTML = getHeparinProtocolHTML();
    document.getElementById('oxygenation-content').innerHTML = getOxygenationHealthHTML();
    
    // --- Global State ---
    let calculatedFlowL = null;
    let ecmoMode = 'VV';
    let heparinProtocol = 'aPTT';

    // --- DOM Elements ---
    const mainContainer = document.querySelector('.main-container');
    const tabs = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    
    // --- Flow Calc Elements ---
    const flowVVModeBtn = document.getElementById('flow-vv-mode-btn');
    const flowVAModeBtn = document.getElementById('flow-va-mode-btn');
    const flowVVInputs = document.getElementById('flow-vv-inputs');
    const flowVAInputs = document.getElementById('flow-va-inputs');
    const flowVVFormulas = document.getElementById('flow-vv-formulas');
    const flowVAFormulas = document.getElementById('flow-va-formulas');
    const flowWeightSlider = document.getElementById('flow-weight-slider');
    const flowWeightValue = document.getElementById('flow-weight-value');
    const flowHeightSlider = document.getElementById('flow-height-slider');
    const flowHeightValue = document.getElementById('flow-height-value');
    const flowRateSlider = document.getElementById('flow-rate');
    const flowRateValue = document.getElementById('flow-rate-value');
    const flowCurrentSlider = document.getElementById('flow-current-slider');
    const flowCurrentValue = document.getElementById('flow-current-value');
    const flowResultEl = document.getElementById('flow-result');
    const vaResultDetails = document.getElementById('va-result-details');
    const vaSupportPercentEl = document.getElementById('va-support-percent');
    
    // --- Cannula Calc Elements ---
    const cannulaWeightSlider = document.getElementById('cannula-weight-slider');
    const cannulaWeightValue = document.getElementById('cannula-weight-value');
    const cannulaFlowInput = document.getElementById('cannula-flow');
    const drainageSelect = document.getElementById('drainage-cannula-select');
    const returnSelect = document.getElementById('return-cannula-select');
    const drainageGraphContainer = document.getElementById('drainage-graph-container');
    const returnGraphContainer = document.getElementById('return-graph-container');

    // --- Heparin Calc Elements ---
    const heparinAPTTBtn = document.getElementById('heparin-aptt-btn');
    const heparinACTBtn = document.getElementById('heparin-act-btn');
    const heparinXaBtn = document.getElementById('heparin-xa-btn');
    const heparinWeightSlider = document.getElementById('heparin-weight-slider');
    const heparinWeightValue = document.getElementById('heparin-weight-value');
    const heparinLabValueSlider = document.getElementById('heparin-lab-value-slider');
    const heparinLabValue = document.getElementById('heparin-lab-value');
    const labTypeLabel = document.getElementById('lab-type-label');
    const heparinCurrentRateInput = document.getElementById('heparin-current-rate-input');
    const heparinRateUnitSelect = document.getElementById('heparin-rate-unit-select');
    const heparinUnitsInput = document.getElementById('heparin-units');
    const heparinVolumeInput = document.getElementById('heparin-volume');
    const heparinResultContainer = document.getElementById('heparin-result-container');
    const heparinActionEl = document.getElementById('heparin-action');
    const heparinNewRateEl = document.getElementById('heparin-new-rate');
    const heparinTargetMinInput = document.getElementById('heparin-target-min');
    const heparinTargetMaxInput = document.getElementById('heparin-target-max');
    
    // --- Oxygenation Elements ---
    const oxyFlowSlider = document.getElementById('oxy-flow-slider');
    const oxyFlowValue = document.getElementById('oxy-flow-value');
    const oxyHbSlider = document.getElementById('oxy-hb-slider');
    const oxyHbValue = document.getElementById('oxy-hb-value');
    const oxySao2Slider = document.getElementById('oxy-sao2-slider');
    const oxySao2Value = document.getElementById('oxy-sao2-value');
    const oxyPao2Input = document.getElementById('oxy-pao2-input');
    const oxySvo2Slider = document.getElementById('oxy-svo2-slider');
    const oxySvo2Value = document.getElementById('oxy-svo2-value');
    const oxyPvo2Input = document.getElementById('oxy-pvo2-input');
    const oxyPreSatSlider = document.getElementById('oxy-pre-sat-slider');
    const oxyPreSatValue = document.getElementById('oxy-pre-sat-value');
    const oxyPostSatSlider = document.getElementById('oxy-post-sat-slider');
    const oxyPostSatValue = document.getElementById('oxy-post-sat-value');
    const oxyRecirculationResultEl = document.getElementById('oxy-recirculation-result');
    const oxyRecircSvo2Slider = document.getElementById('oxy-recirc-svo2-slider');
    const oxyRecircSvo2Value = document.getElementById('oxy-recirc-svo2-value');
    const oxyModelSelect = document.getElementById('oxy-model-select');
    const oxyTmpInput = document.getElementById('oxy-tmp-input');
    const oxyPrePao2Input = document.getElementById('oxy-pre-pao2-input');
    const oxyPostPao2Input = document.getElementById('oxy-post-pao2-input');
    const oxyHealthResultEl = document.getElementById('oxy-health-result');
    const oxyDo2ResultEl = document.getElementById('oxy-do2-result');
    const oxyVo2ResultEl = document.getElementById('oxy-vo2-result');
    const oxyOerResultEl = document.getElementById('oxy-oer-result');
    const oxyTransferResultEl = document.getElementById('oxy-transfer-result');

    // --- Data and Constants ---
    const cannulaDatabase = [
        // Maquet HLS
        { key: 'M-17V', brand: 'Maquet HLS', type: 'Venous', size: '17 Fr', pressureFunc: flow => -1 * (2.8 * Math.pow(flow, 2) + 6.0 * flow) },
        { key: 'M-19V', brand: 'Maquet HLS', type: 'Venous', size: '19 Fr', pressureFunc: flow => -1 * (1.9 * Math.pow(flow, 2) + 5.0 * flow) },
        { key: 'M-21V', brand: 'Maquet HLS', type: 'Venous', size: '21 Fr', pressureFunc: flow => -1 * (1.3 * Math.pow(flow, 2) + 4.5 * flow) },
        { key: 'M-23V', brand: 'Maquet HLS', type: 'Venous', size: '23 Fr', pressureFunc: flow => -1 * (1.1 * Math.pow(flow, 2) + 4.0 * flow) },
        { key: 'M-25V', brand: 'Maquet HLS', type: 'Venous', size: '25 Fr', pressureFunc: flow => -1 * (0.8 * Math.pow(flow, 2) + 3.5 * flow) },
        { key: 'M-15A', brand: 'Maquet HLS', type: 'Arterial', size: '15 Fr', pressureFunc: flow => 6.0 * Math.pow(flow, 2) + 15 * flow },
        { key: 'M-17A', brand: 'Maquet HLS', type: 'Arterial', size: '17 Fr', pressureFunc: flow => 4.5 * Math.pow(flow, 2) + 12 * flow },
        { key: 'M-19A', brand: 'Maquet HLS', type: 'Arterial', size: '19 Fr', pressureFunc: flow => 3.2 * Math.pow(flow, 2) + 10 * flow },
        { key: 'M-21A', brand: 'Maquet HLS', type: 'Arterial', size: '21 Fr', pressureFunc: flow => 2.0 * Math.pow(flow, 2) + 8 * flow },
        
        // Medtronic Bio-Medicus
        { key: 'B-17V', brand: 'Medtronic Bio-Medicus', type: 'Venous', size: '17 Fr', pressureFunc: flow => -1 * (3.0 * Math.pow(flow, 2) + 6.5 * flow) },
        { key: 'B-19V', brand: 'Medtronic Bio-Medicus', type: 'Venous', size: '19 Fr', pressureFunc: flow => -1 * (2.2 * Math.pow(flow, 2) + 5.5 * flow) },
        { key: 'B-21V', brand: 'Medtronic Bio-Medicus', type: 'Venous', size: '21 Fr', pressureFunc: flow => -1 * (1.5 * Math.pow(flow, 2) + 5.0 * flow) },
        { key: 'B-23V', brand: 'Medtronic Bio-Medicus', type: 'Venous', size: '23 Fr', pressureFunc: flow => -1 * (1.2 * Math.pow(flow, 2) + 4.2 * flow) },
        { key: 'B-25V', brand: 'Medtronic Bio-Medicus', type: 'Venous', size: '25 Fr', pressureFunc: flow => -1 * (1.0 * Math.pow(flow, 2) + 4.0 * flow) },
        { key: 'B-15A', brand: 'Medtronic Bio-Medicus', type: 'Arterial', size: '15 Fr', pressureFunc: flow => 7.0 * Math.pow(flow, 2) + 16 * flow },
        { key: 'B-17A', brand: 'Medtronic Bio-Medicus', type: 'Arterial', size: '17 Fr', pressureFunc: flow => 5.0 * Math.pow(flow, 2) + 13 * flow },
        { key: 'B-19A', brand: 'Medtronic Bio-Medicus', type: 'Arterial', size: '19 Fr', pressureFunc: flow => 3.5 * Math.pow(flow, 2) + 11 * flow },
        { key: 'B-21A', brand: 'Medtronic Bio-Medicus', type: 'Arterial', size: '21 Fr', pressureFunc: flow => 2.5 * Math.pow(flow, 2) + 9 * flow },

        // Edwards Lifesciences
        { key: 'E-18V', brand: 'Edwards Fem-Flex', type: 'Venous', size: '18 Fr', pressureFunc: flow => -1 * (2.5 * Math.pow(flow, 2) + 5.8 * flow) },
        { key: 'E-20V', brand: 'Edwards Fem-Flex', type: 'Venous', size: '20 Fr', pressureFunc: flow => -1 * (1.8 * Math.pow(flow, 2) + 5.2 * flow) },
        { key: 'E-16A', brand: 'Edwards Fem-Flex', type: 'Arterial', size: '16 Fr', pressureFunc: flow => 5.5 * Math.pow(flow, 2) + 14 * flow },
        { key: 'E-18A', brand: 'Edwards Fem-Flex', type: 'Arterial', size: '18 Fr', pressureFunc: flow => 4.0 * Math.pow(flow, 2) + 11.5 * flow },
    ];
    const drainageCannulas = cannulaDatabase.filter(c => c.type === 'Venous').sort((a,b) => parseInt(a.size) - parseInt(b.size));
    const returnCannulas = cannulaDatabase.filter(c => c.type === 'Arterial').sort((a,b) => parseInt(a.size) - parseInt(b.size));

    let protocols = {
        aPTT: [
            { range: [0, 45], bolus: 80, change: 4, hold: 0 },
            { range: [46, 54], bolus: 40, change: 2, hold: 0 },
            { range: [55, 75], bolus: 0, change: 0, hold: 0 },
            { range: [76, 90], bolus: 0, change: -2, hold: 0 },
            { range: [91, 100], bolus: 0, change: -2, hold: 30 },
            { range: [101, 150], bolus: 0, change: -3, hold: 60 }
        ],
        ACT: [
            { range: [0, 159], bolus: 80, change: 4, hold: 0 },
            { range: [160, 179], bolus: 40, change: 2, hold: 0 },
            { range: [180, 220], bolus: 0, change: 0, hold: 0 },
            { range: [221, 240], bolus: 0, change: -2, hold: 0 },
            { range: [241, 260], bolus: 0, change: -2, hold: 30 },
            { range: [261, 300], bolus: 0, change: -3, hold: 60 }
        ],
        Xa: [
            { range: [0, 0.19], bolus: 40, change: 2, hold: 0 },
            { range: [0.2, 0.29], bolus: 0, change: 1, hold: 0 },
            { range: [0.3, 0.7], bolus: 0, change: 0, hold: 0 },
            { range: [0.71, 1.0], bolus: 0, change: -1, hold: 0 },
            { range: [1.01, 1.5], bolus: 0, change: -2, hold: 60 },
        ]
    };
    
    const oxygenatorSpecs = {
        'maquet-quadrox': { name: 'Maquet Quadrox-i', tmpRange: [20, 50], watchThreshold: 60, changeThreshold: 80, postO2: 400 },
        'medtronic-nautilus': { name: 'Medtronic Nautilus', tmpRange: [25, 60], watchThreshold: 75, changeThreshold: 90, postO2: 380 },
        'terumo-capiox': { name: 'Terumo Capiox RX', tmpRange: [20, 55], watchThreshold: 70, changeThreshold: 85, postO2: 420 },
        'livanova-inspire': { name: 'LivaNova (Sorin) Inspire', tmpRange: [25, 65], watchThreshold: 75, changeThreshold: 95, postO2: 400 },
        'medos-hilite': { name: 'Medos Hilite 7000', tmpRange: [20, 50], watchThreshold: 65, changeThreshold: 80, postO2: 415 },
        'eurosets-admiral': { name: 'Eurosets Admiral', tmpRange: [15, 50], watchThreshold: 60, changeThreshold: 75, postO2: 410 },
    };

    // --- Initial Animation ---
    setTimeout(() => mainContainer.style.opacity = '1', 100);

    // --- Tab Logic ---
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const targetId = tab.dataset.tab + '-content';
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            tabContents.forEach(content => {
                content.classList.toggle('hidden', content.id !== targetId);
            });
            if (tab.dataset.tab === 'cannula') syncToCannulaTab();
            if (tab.dataset.tab === 'oxygenation') syncToOxygenationTab();
        });
    });
    
    // --- Shared Functions ---
    function addSliderListener(slider, valueEl, unit, decimals = 1, callback = null) {
        if (!slider) return;
        const update = () => {
            if (valueEl) valueEl.textContent = `${parseFloat(slider.value).toFixed(decimals)} ${unit}`;
            if(callback) callback();
        };
        slider.addEventListener('input', update);
        update(); // Initial call
    }

    // --- Flow Calculation Logic ---
    function setFlowMode(mode) {
        ecmoMode = mode;
        const isVV = mode === 'VV';
        flowVAModeBtn.classList.toggle('active', !isVV);
        flowVVModeBtn.classList.toggle('active', isVV);
        flowVAInputs.classList.toggle('hidden', isVV);
        flowVVInputs.classList.toggle('hidden', !isVV);
        flowVAFormulas.classList.toggle('hidden', isVV);
        flowVVFormulas.classList.toggle('hidden', !isVV);
        updateFlowCalculation();
    }

    function calculateTargetFlow(mode, weight, height, rate) {
        if (!weight || weight <= 0) return null;
        if (mode === 'VV') {
            return (weight * rate) / 1000;
        } else { // VA Mode
            if (!height || height <= 0) return null;
            const bsa = 0.007184 * Math.pow(height, 0.725) * Math.pow(weight, 0.425);
            const cardiacOutput = bsa * 3.0; // CI of 3.0 L/min/m^2
            return cardiacOutput * 0.80; // Target 80% support
        }
    }
    
    function updateFlowCalculation() {
        vaResultDetails.innerHTML = '';
        vaSupportPercentEl.innerHTML = '';
        const weight = parseFloat(flowWeightSlider.value);
        const height = parseFloat(flowHeightSlider.value);
        const rate = parseInt(flowRateSlider.value);
        
        calculatedFlowL = calculateTargetFlow(ecmoMode, weight, height, rate);

        if (calculatedFlowL === null) {
            flowResultEl.textContent = '-';
            return;
        }

        if (ecmoMode === 'VA') {
            const bsa = 0.007184 * Math.pow(height, 0.725) * Math.pow(weight, 0.425);
            const cardiacOutput = bsa * 3.0;
            vaResultDetails.innerHTML = `<span>Est. BSA: ${bsa.toFixed(2)} m²</span> &bull; <span>Est. CO: ${cardiacOutput.toFixed(2)} L/min</span>`;
            
            const currentFlow = parseFloat(flowCurrentSlider.value);
            const supportPercent = (currentFlow / cardiacOutput) * 100;
            vaSupportPercentEl.innerHTML = `Providing <strong class="text-green-600">${supportPercent.toFixed(0)}%</strong> cardiac support.`;
        }
        
        flowResultEl.textContent = `${calculatedFlowL.toFixed(2)} L/min`;
    }

    // --- Cannula Sizing Logic ---
    const populateCannulaSelects = () => {
        ['drainage', 'return'].forEach(type => {
            const selectEl = type === 'drainage' ? drainageSelect : returnSelect;
            const cannulas = type === 'drainage' ? drainageCannulas : returnCannulas;
            const brands = [...new Set(cannulas.map(c => c.brand))];
            
            selectEl.innerHTML = '';
            brands.forEach(brand => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = brand;
                cannulas.filter(c => c.brand === brand).forEach(cannula => {
                    const option = new Option(`${cannula.size} (${cannula.brand.split(' ')[0]})`, cannula.key);
                    optgroup.appendChild(option);
                });
                selectEl.appendChild(optgroup);
            });
        });
    };
    
    function updateCannulaSizing() {
        const weight = parseFloat(cannulaWeightSlider.value);
        
        // Set the default operating flow if the input is empty
        if (!cannulaFlowInput.value) {
            const defaultFlow = (weight * 60) / 1000; // Default to 60 ml/kg/min
            cannulaFlowInput.value = defaultFlow.toFixed(2);
        }
        
        // Calculate the recommended flow range and target
        const minFlow = (weight * 50) / 1000;
        const maxFlow = (weight * 70) / 1000;
        const targetFlow = (weight * 60) / 1000;
        const operatingFlow = parseFloat(cannulaFlowInput.value) || 0;
        
        // Recommend cannulas based on weight
        let recDrainageKey, recReturnKey;
        if (weight < 40) { recDrainageKey = 'B-19V'; recReturnKey = 'M-15A'; }
        else if (weight < 70) { recDrainageKey = 'M-23V'; recReturnKey = 'B-19A'; }
        else { recDrainageKey = 'M-25V'; recReturnKey = 'M-21A'; }
        
        [drainageSelect, returnSelect].forEach(select => {
            if(!select.value) select.value = select === drainageSelect ? recDrainageKey : recReturnKey;
            const recKey = select === drainageSelect ? recDrainageKey : recReturnKey;
            select.querySelectorAll('option').forEach(opt => opt.classList.toggle('recommended-cannula', opt.value === recKey));
        });
        
        // Generate graphs with the flow range and current operating point
        const commonOptions = { xMax: 8 };
        generateSVGGraph(drainageGraphContainer, drainageCannulas, drainageSelect.value, operatingFlow, minFlow, maxFlow, targetFlow, { ...commonOptions, title: 'Drainage Pressure-Flow', yMax: 0, yMin: -100, limit: -60, yAxisLabel: 'Pressure (-mmHg)' });
        generateSVGGraph(returnGraphContainer, returnCannulas, returnSelect.value, operatingFlow, minFlow, maxFlow, targetFlow, { ...commonOptions, title: 'Return Pressure-Flow', yMax: 300, yMin: 0, limit: 250, yAxisLabel: 'Pressure (+mmHg)' });
    }
    
    // --- Heparin Protocol Logic ---
    function setHeparinProtocol(protocol) {
        heparinProtocol = protocol;
        [heparinAPTTBtn, heparinACTBtn, heparinXaBtn].forEach(btn => btn.classList.remove('active'));
        
        const labSlider = heparinLabValueSlider;
        let settings = {};
        
        const therapeuticRow = protocols[heparinProtocol].find(p => p.change === 0 && p.bolus === 0);
        const therapeuticRange = therapeuticRow ? therapeuticRow.range : [0,0];

        if (protocol === 'aPTT') {
            heparinAPTTBtn.classList.add('active');
            settings = { min: 30, max: 150, value: therapeuticRange[0] || 65, step: 1 };
        } else if (protocol === 'ACT') {
            heparinACTBtn.classList.add('active');
            settings = { min: 100, max: 300, value: therapeuticRange[0] || 180, step: 1 };
        } else { // Xa
            heparinXaBtn.classList.add('active');
            settings = { min: 0, max: 1.5, value: therapeuticRange[0] || 0.5, step: 0.01 };
        }
        
        Object.assign(labSlider, settings);
        heparinLabValue.textContent = `${parseFloat(labSlider.value).toFixed(protocol === 'Xa' ? 2 : 0)}`;
        labTypeLabel.textContent = protocol.toUpperCase();
        
        heparinTargetMinInput.value = therapeuticRange[0];
        heparinTargetMaxInput.value = therapeuticRange[1];
        const step = protocol === 'Xa' ? '0.01' : '1';
        heparinTargetMinInput.step = step;
        heparinTargetMaxInput.step = step;

        updateHeparinCalculation();
    }

    function updateHeparinCalculation() {
        const weight = parseFloat(heparinWeightSlider.value);
        const labValue = parseFloat(heparinLabValueSlider.value);
        const units = parseFloat(heparinUnitsInput.value);
        const volume = parseFloat(heparinVolumeInput.value);
        const currentRateInput = parseFloat(heparinCurrentRateInput.value);
        const rateUnit = heparinRateUnitSelect.value;
        const newMin = parseFloat(heparinTargetMinInput.value);
        const newMax = parseFloat(heparinTargetMaxInput.value);
        
        if ([weight, labValue, units, volume, currentRateInput, newMin, newMax].some(isNaN) || volume === 0) {
            heparinResultContainer.classList.add('hidden');
            return;
        }

        const currentProtocolData = JSON.parse(JSON.stringify(protocols[heparinProtocol]));
        const therapeuticRow = currentProtocolData.find(p => p.change === 0 && p.bolus === 0);
        if (therapeuticRow) therapeuticRow.range = [newMin, newMax];

        const concentration = units / volume;
        let currentRateInUnits = rateUnit === 'units' ? currentRateInput : (currentRateInput * concentration) / weight;

        const action = currentProtocolData.find(p => labValue >= p.range[0] && labValue <= p.range[1]);
        
        if (!action) {
             heparinActionEl.textContent = 'Value out of protocol range.';
             heparinNewRateEl.innerHTML = '-';
             heparinResultContainer.classList.remove('hidden');
             return;
        }

        let actionText = [];
        if (action.bolus > 0) actionText.push(`Bolus ${(action.bolus * weight).toFixed(0)} units`);
        if (action.hold > 0) actionText.push(`Hold infusion for ${action.hold} min`);
        if (action.bolus > 0 || action.hold > 0) actionText.push('then');
        if (action.change !== 0) {
             actionText.push(`${action.change > 0 ? 'Increase' : 'Decrease'} rate by ${Math.abs(action.change)} u/kg/hr.`);
        }
        if (action.change === 0 && action.bolus === 0) actionText = ["No change to infusion rate."];

        heparinActionEl.textContent = actionText.join(' ');
        
        const newRateInUnits = currentRateInUnits + action.change;
        const newRateInMl = (newRateInUnits * weight) / concentration;
        heparinNewRateEl.innerHTML = `${newRateInUnits.toFixed(1)} u/kg/hr <span class="text-sm text-gray-600 font-normal">(${newRateInMl.toFixed(1)} mL/hr)</span>`;

        heparinResultContainer.classList.remove('hidden');
    }

    // --- Oxygenation & Health Logic ---
    function populateOxygenatorSelect() {
        oxyModelSelect.innerHTML = '';
        for (const [key, value] of Object.entries(oxygenatorSpecs)) {
            oxyModelSelect.add(new Option(value.name, key));
        }
    }

    function calculateOxygenContent(hb, sat, po2) {
        if(isNaN(hb) || isNaN(sat) || isNaN(po2)) return null;
        return (hb * 1.34 * (sat / 100)) + (po2 * 0.003);
    }
    
    function syncSvo2Sliders(sourceSlider) {
        const value = sourceSlider.value;
        const text = `${parseFloat(value).toFixed(0)} %`;
        oxySvo2Slider.value = value;
        oxyRecircSvo2Slider.value = value;
        oxySvo2Value.textContent = text;
        oxyRecircSvo2Value.textContent = text;
        updateOxygenationCalculations();
    }
    
    function updateOxygenationCalculations() {
        const flow = parseFloat(oxyFlowSlider.value);
        const hb = parseFloat(oxyHbSlider.value);
        const sao2 = parseFloat(oxySao2Slider.value);
        const pao2 = parseFloat(oxyPao2Input.value);
        const svo2 = parseFloat(oxySvo2Slider.value);
        const pvo2 = parseFloat(oxyPvo2Input.value);
        
        const preSat = parseFloat(oxyPreSatSlider.value);
        const postSat = parseFloat(oxyPostSatSlider.value);
        
        const currentTmp = parseFloat(oxyTmpInput.value);
        const prePao2 = parseFloat(oxyPrePao2Input.value);
        const postPao2 = parseFloat(oxyPostPao2Input.value);
        const selectedModelKey = oxyModelSelect.value;
        const modelSpecs = oxygenatorSpecs[selectedModelKey];

        // Systemic Calcs
        const cao2 = calculateOxygenContent(hb, sao2, pao2);
        const cvo2 = calculateOxygenContent(hb, svo2, pvo2);
        
        const do2 = (cao2 && flow) ? flow * cao2 * 10 : null;
        oxyDo2ResultEl.innerHTML = `${do2 ? do2.toFixed(0) : '-'} <span class="text-base font-normal">mL/min</span>`;
        
        const vo2 = (cao2 && cvo2 && flow) ? flow * (cao2 - cvo2) * 10 : null;
        oxyVo2ResultEl.innerHTML = `${vo2 ? vo2.toFixed(0) : '-'} <span class="text-base font-normal">mL/min</span>`;

        const oer = (cao2 && cvo2 && cao2 > 0) ? ((cao2 - cvo2) / cao2) * 100 : null;
        oxyOerResultEl.innerHTML = `${oer ? oer.toFixed(1) : '-'} <span class="text-base font-normal">%</span>`;
        
        // Recirculation
        let recirc = null;
        if (!isNaN(preSat) && !isNaN(postSat) && !isNaN(svo2) && (postSat - svo2) > 0) {
             recirc = ((preSat - svo2) / (postSat - svo2)) * 100;
        }
        oxyRecirculationResultEl.textContent = `${recirc !== null ? Math.max(0, recirc).toFixed(1) : '-'} %`;

        // Oxygenator Health
        const oxygenTransfer = (flow && hb && !isNaN(postSat) && !isNaN(preSat)) ? (flow * 1.34 * hb * ((postSat - preSat) / 100)) * 10 : null;
        oxyTransferResultEl.textContent = `${oxygenTransfer ? oxygenTransfer.toFixed(0) : '-'}`;
        
        let healthHTML = '';
        if (modelSpecs) {
            let tmpStatus = 'Normal';
            let tmpColor = 'text-green-600';
            if (currentTmp >= modelSpecs.changeThreshold) {
                tmpStatus = 'Consider Change';
                tmpColor = 'text-red-600';
            } else if (currentTmp >= modelSpecs.watchThreshold) {
                tmpStatus = 'Watch';
                tmpColor = 'text-yellow-600';
            }
            healthHTML += `<h4 class="font-semibold text-gray-800 text-sm">TMP Status</h4><p class="text-xl font-bold ${tmpColor}">${isNaN(currentTmp) ? '-' : tmpStatus}</p><p class="text-xs text-gray-500">Normal: ${modelSpecs.tmpRange[0]}-${modelSpecs.tmpRange[1]} mmHg</p>`;
        }
        if(!isNaN(prePao2) && !isNaN(postPao2)) {
            const gradient = postPao2 - prePao2;
            healthHTML += `<h4 class="font-semibold text-gray-800 text-sm mt-2">PaO₂ Gradient</h4><p class="text-xl font-bold text-accent">${gradient.toFixed(0)} mmHg</p><p class="text-xs text-gray-500">Expected Post: >${modelSpecs ? modelSpecs.postO2 : 'N/A'} mmHg</p>`;
        }
        oxyHealthResultEl.innerHTML = healthHTML;
    }
    
    // --- Event Listeners & Initial Calls ---

    // Flow
    addSliderListener(flowWeightSlider, flowWeightValue, 'kg', 0, updateFlowCalculation);
    addSliderListener(flowHeightSlider, flowHeightValue, 'cm', 0, updateFlowCalculation);
    addSliderListener(flowRateSlider, flowRateValue, 'ml/kg/min', 0, updateFlowCalculation);
    addSliderListener(flowCurrentSlider, flowCurrentValue, 'L/min', 1, updateFlowCalculation);
    flowVVModeBtn.addEventListener('click', () => setFlowMode('VV'));
    flowVAModeBtn.addEventListener('click', () => setFlowMode('VA'));

    // Cannula
    addSliderListener(cannulaWeightSlider, cannulaWeightValue, 'kg', 0, updateCannulaSizing);
    [cannulaFlowInput, drainageSelect, returnSelect].forEach(el => el.addEventListener('input', updateCannulaSizing));
    
    // Heparin
    addSliderListener(heparinWeightSlider, heparinWeightValue, 'kg', 0, updateHeparinCalculation);
    heparinLabValueSlider.addEventListener('input', e => { 
        const decimals = heparinProtocol === 'Xa' ? 2 : 0;
        heparinLabValue.textContent = parseFloat(e.target.value).toFixed(decimals); 
        updateHeparinCalculation(); 
    });
    [heparinUnitsInput, heparinVolumeInput, heparinCurrentRateInput, heparinRateUnitSelect, heparinTargetMinInput, heparinTargetMaxInput].forEach(el => el.addEventListener('input', updateHeparinCalculation));
    heparinAPTTBtn.addEventListener('click', () => setHeparinProtocol('aPTT'));
    heparinACTBtn.addEventListener('click', () => setHeparinProtocol('ACT'));
    heparinXaBtn.addEventListener('click', () => setHeparinProtocol('Xa'));

    // Oxygenation
    const oxyInputs = [ oxyPao2Input, oxyPvo2Input, oxyModelSelect, oxyTmpInput, oxyPrePao2Input, oxyPostPao2Input ];
    oxyInputs.forEach(el => el.addEventListener('input', updateOxygenationCalculations));
    addSliderListener(oxyFlowSlider, oxyFlowValue, 'L/min', 1, updateOxygenationCalculations);
    addSliderListener(oxyHbSlider, oxyHbValue, 'g/dL', 1, updateOxygenationCalculations);
    addSliderListener(oxyPreSatSlider, oxyPreSatValue, '%', 0, updateOxygenationCalculations);
    addSliderListener(oxyPostSatSlider, oxyPostSatValue, '%', 1, updateOxygenationCalculations);
    addSliderListener(oxySao2Slider, oxySao2Value, '%', 0, updateOxygenationCalculations);
    
    oxySvo2Slider.addEventListener('input', () => syncSvo2Sliders(oxySvo2Slider));
    oxyRecircSvo2Slider.addEventListener('input', () => syncSvo2Sliders(oxyRecircSvo2Slider));

    // Syncing
    function syncToCannulaTab() {
        cannulaWeightSlider.value = flowWeightSlider.value;
        // Trigger a change event to update the value display and recalculate
        cannulaWeightSlider.dispatchEvent(new Event('input', { bubbles: true }));
    }
    
    function syncToOxygenationTab() {
        if (calculatedFlowL) {
            oxyFlowSlider.value = calculatedFlowL;
        }
        syncSvo2Sliders(oxySvo2Slider); // This will also trigger updateOxygenationCalculations
    }
    
    // Initial Setup Calls
    populateCannulaSelects();
    populateOxygenatorSelect();
    setFlowMode('VV');
    setHeparinProtocol('aPTT');
    updateCannulaSizing();
    syncSvo2Sliders(oxySvo2Slider); // Initial call to sync and calculate
});

// --- HELPER FUNCTIONS --- //
function generateSVGGraph(container, data, activeKey, opFlow, minFlow, maxFlow, targetFlow, options) {
    const { title, xMax, yMax, yMin, limit, yAxisLabel } = options;
    const width = 500, height = 280, margin = { top: 40, right: 40, bottom: 40, left: 50 };
    
    const xScale = val => margin.left + (val / xMax * (width - margin.left - margin.right));
    const yScale = val => (height - margin.bottom) - ((val - yMin) / (yMax - yMin) * (height - margin.top - margin.bottom));

    const curves = data.map(cannula => {
        let pathData = "M";
        for (let i = 0; i <= xMax; i += 0.1) {
            let pressure = cannula.pressureFunc(i);
            if (pressure >= yMin && pressure <= yMax) {
                pathData += `${xScale(i)},${yScale(pressure)} L`;
            }
        }
        return `<path d="${pathData.slice(0, -2)}" class="curve ${cannula.key === activeKey ? 'curve-active' : 'curve-inactive'}" />`;
    }).join('');

    let opPointCircle = '';
    const selectedCannula = data.find(c => c.key === activeKey);
    if (opFlow > 0 && selectedCannula) {
        const pressure = selectedCannula.pressureFunc(opFlow);
        if (pressure >= yMin && pressure <= yMax) {
            opPointCircle = `<circle cx="${xScale(opFlow)}" cy="${yScale(pressure)}" class="op-point visible" />`;
        }
    }
    
    let targetFlowColumn = '';
    if (minFlow > 0 && maxFlow > minFlow) {
        const startX = xScale(minFlow);
        const endX = xScale(maxFlow);
        targetFlowColumn = `
            <rect x="${startX}" y="${margin.top}" width="${endX - startX}" height="${height - margin.top - margin.bottom}" class="target-flow-range" />
            <text x="${startX}" y="${margin.top - 5}" class="axis-label" text-anchor="start">${minFlow.toFixed(1)}</text>
            <text x="${endX}" y="${margin.top - 5}" class="axis-label" text-anchor="end">${maxFlow.toFixed(1)}</text>
        `;
    }
    
    let targetFlowLine = '';
    if (targetFlow > 0) {
        const flowX = xScale(targetFlow);
        targetFlowLine = `<line x1="${flowX}" y1="${margin.top}" x2="${flowX}" y2="${height - margin.bottom}" class="target-flow-line" />`;
    }

    const xGridLines = Array.from({ length: Math.floor(xMax / 2) + 1 }, (_, i) => `<line x1="${xScale(i * 2)}" y1="${margin.top}" x2="${xScale(i * 2)}" y2="${height - margin.bottom}" class="grid-line" />`).join('');
    const numYGrid = 5;
    const yGridLines = Array.from({ length: numYGrid + 1 }, (_, i) => {
        const yVal = yMin + i * ((yMax - yMin) / numYGrid);
        return `<line x1="${margin.left}" y1="${yScale(yVal)}" x2="${width - margin.right}" y2="${yScale(yVal)}" class="grid-line" />`
    }).join('');
    
    const xLabels = Array.from({ length: Math.floor(xMax / 2) + 1 }, (_, i) => `<text x="${xScale(i * 2)}" y="${height - margin.bottom + 15}" text-anchor="middle" class="axis-label">${i * 2}</text>`).join('');
    const yLabels = Array.from({ length: numYGrid + 1 }, (_, i) => {
        const yVal = yMin + i * ((yMax - yMin) / numYGrid);
        return `<text x="${margin.left - 8}" y="${yScale(yVal) + 4}" text-anchor="end" class="axis-label">${yVal.toFixed(0)}</text>`
    }).join('');

    const axisTitles = `<text x="${width / 2}" y="${height - 5}" text-anchor="middle" class="axis-label font-semibold">Flow (L/min)</text>
                       <text x="${-(height / 2)}" y="15" transform="rotate(-90)" text-anchor="middle" class="axis-label font-semibold">${yAxisLabel}</text>
                       <text x="${width / 2}" y="${margin.top - 15}" text-anchor="middle" class="text-lg font-semibold text-gray-800">${title}</text>`;

    const limitLine = `<line x1="${margin.left}" y1="${yScale(limit)}" x2="${width - margin.right}" y2="${yScale(limit)}" class="limit-line" />
                       <text x="${width - margin.right + 5}" y="${yScale(limit) + 4}" class="text-xs fill-red-500">${limit} mmHg</text>`;

    const svg = `
        <svg viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg">
            ${xGridLines} ${yGridLines}
            ${targetFlowColumn}
            ${targetFlowLine}
            <line x1="${margin.left}" y1="${margin.top}" x2="${margin.left}" y2="${height - margin.bottom}" class="axis-line" />
            <line x1="${margin.left}" y1="${height - margin.bottom}" x2="${width - margin.right}" y2="${height - margin.bottom}" class="axis-line" />
            ${curves}
            ${opPointCircle}
            ${limitLine}
            ${xLabels} ${yLabels}
            ${axisTitles}
        </svg>`;
    container.innerHTML = svg;
}
</script>

</body>
</html>
